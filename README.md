# SATソルバ紹介

N-QUEENを使ってSATソルバの紹介をします。

[このサイト](https://www.dr-mikes-math-games-for-kids.com/eight-queens-puzzle.html)で解の正しさを確かめられます。

## 要点

- SATソルバは論理式を与えると答えを導き出してくれる
- 論理式は、直感的にわかりやすいDNFではなく、CNFで与える
- N-QUEEN問題を解かせてみて、SATソルバの使い方を学ぶ
- SATソルバの発展形(SMTソルバ)もあり、AWSのネットワーク・アクセス制御にも使われている
  - https://logmi.jp/tech/articles/326121
  - バックエンドで応用できる可能性はチラホラある！(ただパズルを解くためのソルバではない)

## SATソルバとは

SATソルバは、SAT問題を解くソフトウェアです。
SAT問題とは、論理式を真にする変数の割り当てを求める問題です。
SATソルバは、論理式を入力として受け取り、その論理式を真にする変数の割り当てを出力します。

論理式の例を示します。
4つの変数1、2、3、4があり、例えばこのうちのどれか1つが真、他はすべて偽である場合について立式します。

```
(1 and -2 and -3 and -4) or (-1 and 2 and -3 and -4) or (-1 and -2 and 3 and -4) or (-1 and -2 and -3 and 4)
```

ここでは偽である場合は-をつけています。
このようにカッコ同士をorでつなげ、カッコ内はandでつなげる論理式をDNF(Disjunctive Normal Form)と言います。

残念ながらSATソルバにはDNFを入力することはできません。
SATソルバには、カッコ同士をandでつなげ、カッコ内はorでつなげる論理式CNF(Conjunctive Normal Form)を入力する必要があります。

```
(1 or 2 or 3 or 4) and (-1 or -2) and (-1 or -3) and (-1 or -4) and (-2 or -3) and (-2 or -4) and (-3 or -4)
```

なんかパット見理解しづらいですが、これがSATソルバに入力する論理式です。
各カッコについて簡単に説明します。

`(1 or 2 or 3 or 4)`は、1から4のうち1つ以上真である必要があるという式です。(at-least-one制約)

`(-1 or -2)`は、1と2のどちらか・もしくは両方が必ず偽であるという式です。つまり、二つともが同時に真にはなりません。
これを全変数の組み合わせで記述したものが
```
(-1 or -2) and (-1 or -3) and (-1 or -4) and (-2 or -3) and (-2 or -4) and (-3 or -4)
```
であり、これは1から4のうち2つ以上真になることがない式です。(at-most-one制約)

このように、at-least-one制約とat-most-one制約を組み合わせてDNFをCNFに変換することができました。
**at-least-one制約**と**at-most-one制約**を組み合わせて、論理式を組み立てていくところが、
SATソルバを使ったプログラム体験の面白いところです。

## N-QUEENとは

N-QUEENとは、N×Nのチェス盤にN個のクイーンを置く問題です。
クイーンは、縦・横・斜めのいずれかの方向に動くことができます。
N-QUEENの解とは、N個のクイーンを置いたときに、どのクイーンも他のクイーンに取られないように配置することです。

## N-QUEENのSAT問題

N-QUEENの解を求めるために、SAT問題を作ります。N-QUEENのSAT問題は、N×N個の変数からなります。

変数は、N×N個のマスに対応します。変数は、マスにクイーンを置くかどうかを表します。
変数の値が真のとき、そのマスにクイーンを置きます。変数の値が偽のとき、そのマスにクイーンを置きません。

変数名とマスの関係を以下のように定義します。(ここでは、N=4で説明)

```
  1  2  3  4
 11 12 13 14
 21 22 23 24
 31 32 33 34
```

横・縦・斜めのいずれかの方向に動くことができるという条件を、論理式で表します。

まず横です。at-least-one制約とat-most-one制約で以下のように記述できます。
```
(1 or 2 or 3 or 4)(-1 or -2)(-1 or -3)(-1 or -4)(-2 or -3)(-2 or -4)(-3 or -4)
```
> andは省略しています。

次に縦です。at-least-one制約とat-most-one制約で以下のように記述できます。(一列目)
```
(1 or 11 or 21 or 31)(-1 or -11)(-1 or -21)(-1 or -31)(-11 or -21)(-11 or -31)(-21 or -31)
```

次に斜めですが、とりあえず左上から右下への斜めのみ考えましょう。

斜めについては、at-most-one制約のみで論理式を記述します。
at-least-one制約がいらない理由ですが、 4x4のマスだと7つの斜めがあります。
しかし、すべての斜めにクイーンが必ず一つ配置されるわけではないので、at-least-one制約はいらないのです。

左上から右下への斜めの制約は以下のように記述できます。
```
(-31)
(-21 or -32)
(-11 or -22)(-11 or -33)(-22 or -33)
(-1 or -12)(-1 or -23)(-1 or -34)(-12 or -23)(-12 or -34)(-23 or -34)
(-2 or -13)(-2 or -24)(-13 or -24)
(-3 or -14)
(-4)
```

右上から左下の斜めも同様です。

それでは、実際にプログラムを動作させてみましょう。

```bash
go run n-queen/main.go
```

## デモ中に見せたいこと

- 実行できること
  - 8x8の場合の解を見せ、妥当であることを確認すること
  - [このサイト](https://www.dr-mikes-math-games-for-kids.com/eight-queens-puzzle.html)で解の正しさを確かめる
- 得た解を否定する論理式を追加すると、別の解が得られること

## おまけ

- 変数、論理式のサイズが大きくなると性能が落ちる
  - 特に「少なくとも2つ」「少なくとも5つ」など、「少なくとも[複数]個」を立式すると変数・at-most-one制約の量が増えるので、性能が落ちる
    - まだ僕の経験が不足しているだけで、解決策はあるかもしれません。
- SATソルバを発展させたSMTソルバなら、不等式も扱える
  - AWSのネットワーク・アクセス制御にも使われている
    - https://logmi.jp/tech/articles/326121 